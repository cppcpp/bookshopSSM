<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <title>确认订单</title>
</head>
<body>
<header>
    <div class="row col-lg-12 col-md-12 col-sm-12 col-xs-12"> 
      <div class="col-md-8 col-sm-8" style="display:inline-block">
       	 <button style="float:right;margin:5px;" id="searchBtn">搜索</button>
     	 <input type="text" id="searchBook" style="float:right">
     	
      </div>
      <div style="display:inline-block" class="col-md-3 col-sm-3 col-md-offset-1 clearfix">
     	<ul id="top-bar"  class="clearfix">
	        <li><a href="login.html">登录</a></li>
	        <li><a href="register.html">注册</a></li>
       </ul> 
      </div>
    </div>
</header>

<nav>
  <div class="container">
    <div class="row col-md-12">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header col-md-1">
            <a class="navbar-brand" href="index.html">
              <img src="img/logo.png" alt="Logo">
            </a>
            <button type="button" class="navbar-toggle collapsed button-collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

          </div>
          <!-- id 关联上面的折叠 -->
          <div class="collapse navbar-collapse nav-collapsed-area" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right clearfix">
              <li><a href="index.html">首页</a></li>
              <li><a href="category.html">书城</a></li>
              <li><a href="special.html">特价</a></li>
              <li><a href="mineInfo.html">我的</a></li>
              <li><a href="about.html">关于我们</a></li>
              <li><a href="contact.html">联系我们</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>
    </div>
  </div>
  <div class="nav-cart-area">
    <a href="cart.html"><span class="nav-cart"><img src="img/icon-cart.png"></span></a>
  </div>
</nav>

<!--back to top-->
<p id="back-to-top">
  <a href="#top"><img src="img/top_arrow1.png"/></a>
</p>

<section id="booklist">
  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <div class="categrory">
          <div class="booklist-categrory-top">
            <div><i class="fa fa-list"></i>&nbsp;&nbsp;图&nbsp;书&nbsp;分&nbsp;类</div>
          </div>
          <div class="booklist-categrory-content">
            <ul class="">
              <a href="category.html?category=a" ><li><i class="glyphicon glyphicon-eye-open"></i>马列主义、毛泽东思想(A)</li></a>
              <a href="category.html?category=b" ><li><i class="glyphicon glyphicon-bookmark"></i>哲学(B)</li></a>
              <a href="category.html?category=c" ><li><i class="glyphicon glyphicon-book"></i>社会科学(C)</li></a>
              <a href="category.html?category=d"><li><i class="glyphicon glyphicon-text-width"></i>政治、法律(D)</li></a>
              <a href="category.html?category=e"><li><i class="glyphicon glyphicon-fire"></i>军事(E)</li></a>
              <a href="category.html?category=f"><li><i class="glyphicon glyphicon-asterisk"></i>经济(F)</li></a>
              <a href="category.html?category=g"><li><i class="glyphicon glyphicon-globe"></i>文化、科学、教育、体育(G)</li></a>
              <a href="category.html?category=h"><li><i class="glyphicon glyphicon-leaf"></i>语言、文字(H)</li></a>
              <a href="category.html?category=i"><li><i class="glyphicon glyphicon-user"></i>文学(I)</li></a>
              <a href="category.html?category=j"><li><i class="glyphicon glyphicon-pushpin"></i>艺术(J)</li></a>
              <a href="category.html?category=k"><li><i class="glyphicon glyphicon-paperclip"></i>历史、地理(K)</li></a>
              <a href="category.html?category=n"><li><i class="glyphicon glyphicon-usd"></i>自然科学总论(N)</li></a>
              <a href="category.html?category=o"><li><i class="glyphicon glyphicon-map-marker"></i>数理科学和化学(O)</li></a>
              <a href="category.html?category=p"><li><i class="glyphicon glyphicon-hand-right"></i>天文学、地球科学(P)</li></a>
              <a href="category.html?category=q"><li><i class="glyphicon glyphicon-pushpin"></i>生物科学(Q)</li></a>
              <a href="category.html?category=r"><li><i class="glyphicon glyphicon-paperclip"></i>医药、卫生(R)</li></a>
              <a href="category.html?category=s"><li><i class="glyphicon glyphicon-usd"></i>农业科学(S)</li></a>
              <a href="category.html?category=t"><li><i class="glyphicon glyphicon-map-marker"></i>工业科学(T)</li></a>
              <a href="category.html?category=u"><li><i class="glyphicon glyphicon-hand-right"></i>交通运输(U)</li></a>
              <a href="category.html?category=v"><li><i class="glyphicon glyphicon-usd"></i>航空、航天(V)</li></a>
              <a href="category.html?category=x"><li><i class="glyphicon glyphicon-map-marker"></i>环境科学(X)</li></a>
              <a href="category.html?category=z"><li><i class="glyphicon glyphicon-hand-right"></i>综合性图书(Z)</li></a>
      		</ul>
          </div>
        </div>
      </div>

      <div class="col-md-8 col-md-offset-1">
        <div class="row">
          <div class="nav-title"><i class="fa fa-tasks"></i>&nbsp;&nbsp;图书订单</div>
        </div>
        <div class="row">
            <div class="address-container">
              <!--以下展示的是默认地址-->
              </div>
            
            <div>
                <input type="button" value="选择其他收货地址" class="order_info" id="other_address"/>
                <input type="button" value="新增收货地址" class="order_info" id="add_address" /><br/><br/>
              </div>

            <div class="order-detail">
              <table border="1" class="cart-table" id="cart-table">
	              <thead>
	                <tr class="cart_title">
	                  <th>图片</th>
	                  <th>书名</th>
	                  <th>数量</th>
	                  <th>总价</th>
	                </tr>
	              </thead>
				  <tbody class="table_tbody">
				  </tbody>
              </table>
              <div>
                <input type="submit" value="确认" class="order-ok order_info" style="float: right">
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="address-all" style="z-index:1004"> 
  <div class="circle">X</div>
  <!--遍历所有的已有地址-->
      <div id="exist-lists">
       
      </div>
  <div class="address-b"><input type="button" value="确定" class="edit_default_address"></div>
</div>

	<div class="add_address" style="color:#000;z-index:1004">
        <div class="circles" >X</div>
        <div class="mini-form-input">
          <label>收货人：</label>
          <input type="text" value="" id="addReciver">
        </div>

        <div class="mini-form-input" style="display:flex;align-items:center">
          <label>收货地址：</label>
          <textarea id="addAddress" style="height:auto;margin-left:10px;" rows="3"></textarea>
        </div>

        <div class="mini-form-input">
          <label>收货人电话：</label>
          <input type="text" value="" id="addPhone" onkeyup="WidthCheck(this,11)">
        </div>
		<span class="tip-phone"></span>
        <div class="mini-form-input">
          <label>设为默认：</label>
          <input type="checkbox" id="isDefault">
        </div>
        <div class="mini-form-input">
          <input type="hidden" value="" name="uAddrId">
          <input type="submit" value="确定" class="add_address_button" name="add">
        </div>
   </div>


<!-- footer Start -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="footer-manu">
          <ul>
              <li><a href="index.html">首页</a></li>
              <li><a href="category.html">书城</a></li>
              <li><a href="special.html">特价</a></li>
              <li><a href="mineInfo.html">我的</a></li>
              <li><a href="about.html">关于我们</a></li>
              <li><a href="contact.html">联系我们</a></li>
          </ul>
        </div>
        <p>Copyright &copy; Design & SHY</p>
      </div>
    </div>
  </div>
</footer>
<div id="bg"></div>
</body>
</html>
<script src="js/jquery-2.2.4.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/utils.js"></script>
<script>
var oNum = 0,oPrice=0,uAddress='',uReceiver='',oPhone='',oCheaper=0,ids=[],orderDetails
  $(function () {
	  $("#addPhone").blur(function(){
	        var phone=$("#addPhone").val();
	        console.log(phone)
	        if(!phone){
	            $(".tip-phone").html("电话不能为空！");
	        }else if(!phone.match(/^\d{11}$/)){
	            $(".tip-phone").html("电话号码必须为11位的数字!");
	        }
	    }).focus(function (){
	        $(".tip-phone").html("");
	    });
      $("#add_address").click(function() {
          $(".add_address").slideDown();
          document.getElementById("bg").style.display ="block";
          $("body").css({overflow:"hidden"})
      })

      $(".circles").click(function() {
          $(".add_address").slideUp();
          document.getElementById("bg").style.display ="none";
          $("body").css({overflow:"auto"})
          
      })
      
       $(".circle").click(function() {
          $(".address-all").slideUp();
          document.getElementById("bg").style.display ="none";
          $("body").css({overflow:"auto"})
      })
      
      $("#other_address").click(function(){
    	  $(".address-all").slideDown();
    	  document.getElementById("bg").style.display ="block";
          $("body").css({overflow:"hidden"})
    	  var html= ""
    	  
          $.ajax({
 			url:'user/getUsersInfo',
 			type:'get',
 			success:function(data){
 			  if(data.uAccount){
 				  uAccount = data.uAccount
 				  $.ajax({
 			    	  url:"userAdress/userAddressQry",
 			    	  type:'get',
 			    	  data:{
 			    		  uAccount:uAccount
 			    	  },
 			    	  success:function(data){
 			    		  if(data.userAdressList &&data.userAdressList.length){
 			    			  var html = ''
 			    			  $("#exist-lists").html('')
 			    			  $.each(data.userAdressList,function(index,adata){
 				    			 if(adata['uIsdefault'] == 0) {
 				    				adata['uIsdefault'] = '否'
 				    				html += "  <div class=\"address-info\" name="+adata['uaddrId']+">"
 		 						    html +="<input type=\"radio\" name=\"cate\" class=\"radio_address\" value="+adata['uaddrId']+">"
 		 						    html +="<br/><span>收货人：</span><span class=\"oReceiver\">"+adata['oReceiver']+"</span><br/>"
 		 						    html +="<span>收货地址：</span><span  class=\"uAddress\">"+adata['uAddress']+"</span><br/>"  
 		 				    		html +="<span>联系方式：</span><span class=\"oPhone\">"+adata['oPhone']+"</span>"
 		 				    		html +="</div><br/>"
 				    			 }
 				    			 if(adata['uIsdefault'] == 1) {
 				    				adata['uIsdefault'] = '是'
 				    				html += "  <div class=\"address-info\" name="+adata['uaddrId']+">"
 		 						    html +="<input type=\"radio\" name=\"cate\" class=\"radio_address\" value="+adata['uaddrId']+" checked>"
 		 						    html +="<br/><span>收货人：</span><span class=\"oReceiver\">"+adata['oReceiver']+"</span><br/>"
 		 						    html +="<span>收货地址：</span><span  class=\"uAddress\">"+adata['uAddress']+"</span><br/>"  
 		 				    		html +="<span>联系方式：</span><span class=\"oPhone\">"+adata['oPhone']+"</span>"
 		 				    		html +="</div><br/>"
 				    			 }
 				    		  })
 				    		  $("#exist-lists").append(html)
 				    		  
 			    		  }else {
 			    			
 							 $(".address-container").html("请选择一个地址")
 							 $("#other_address").css("display",'none')
 						}
 			    	  }
 			      })
 			  }
 		}
 	})
  })
      
      if(sessionStorage.getItem("selectedGoods")){
    	  var lists = JSON.parse(sessionStorage.getItem("selectedGoods"))
    	  var html = ''
    	  orderDetails = []
    	  $.each(lists,function(index,data){
			html += "<tr>"
			html +="<td><img class=\"table-img\" src="+data['imgSrc']+"></td>"
    		html += " <td>"+data['bName']+"</td>" 
    		html +="<td>"+data['bNum']+"</td>"
    		html += "<td class=\"sum_money\">"+data['bSumdiscountprice']+"</td><tr>"
    		oNum += Number(data['bNum'])
    		oPrice += Number(data['bSumdiscountprice']) 
    		oCheaper = data['bSumprice'] - data['bSumdiscountprice'] + oCheaper
    		let obj = {
    				"bId":data['bId'],
    				'bName':data['bName'],
    				"bNums":data['bNum'],
    				"bPrice":data['bPrice'],
    				"bDiscountprice":data['bDiscountprice'],
    				"bSumprice":data['bSumprice']+"",
    				"bSumdiscountprice":data['bSumdiscountprice']
    		}
    		  orderDetails.push(obj)
    	  })
    	  html +="<tr> <td colspan=\"4\" class=\"cart_total\"><span class=\"cart-red\">总价(不含运费)</span><span class=\"ac_money\">"+oPrice.toFixed(2)+"</span></span></td></tr>"
    	  $(".table_tbody").append(html)
      }
      if(sessionStorage.getItem('selectedIds')){
    	  ids = JSON.parse(sessionStorage.getItem('selectedIds'))
      }
      
      $(".add_address_button").click(function(){
  		if(!$("#addReciver").val()|| !$("#addAddress").val() ||!$("#addPhone").val()){
  			alert('请完善收获地址')
  		}else{
  			let obj = {
  					'uAddress':$("#addAddress").val(),
  					'oPhone':$("#addPhone").val(),
  					"uIsdefault":$("#isDefault").is(":checked")? 1:0,
  					"oReceiver":$("#addReciver").val()	
  				}
  			if($(".tip-phone").html()){
				return;
			}
  			$.ajax({
  				url:'userAdress/addUserAddress',
  				type:'post',
  				contentType: "application/json; charset=utf-8",
  				data:JSON.stringify(obj),
  				success:function(data){
  				   $(".add_address").slideUp();
  				 	document.getElementById("bg").style.display ="none";
	    	         $("body").css({overflow:"auto"})
	    	         getDefaultAddress()
  				}
  			})
  		}
  	})
  	
  	getDefaultAddress()
      
	$(".order-ok").click(function(){
		let objects = {'orderDetails':orderDetails,'ids':ids,"oNum":oNum,"oPrice":oPrice,"uAddress":uAddress,"uReceiver":uReceiver,"oPhone":oPhone,"oCheaper":oCheaper.toFixed(2)}
		if(uReceiver) {
			$.ajax({
				url:'orders/addOrders',
				type:'post',
				contentType: "application/json; charset=utf-8",
				data:JSON.stringify(objects),
				success:function(){
					  window.location="orderOk.html"  
				}
			})
		}else {
			alert("请选择一个收货地址")
		}
		
	})
	
	$("body").on("click","input:radio[name=\"cate\"]",function(){
		let receiver = $(this).siblings().eq(2).text()
		let phone = $(this).siblings().eq(8).text()
		let address =  $(this).siblings().eq(5).text()
		$(".edit_default_address").click(function(){
			uReceiver = receiver
			oPhone = phone
			uAddress =address
			var html = ""
				html += "<div class=\"item-row\">"
				html += "<span>收货人：&nbsp;&nbsp;"+uReceiver+"</span>"
				html += " <span>"+oPhone+"</span></div>"
				html += "<div>"+uAddress+"</div>"
				$(".address-container").html(html) 
				
				 $(".address-all").slideUp();
				document.getElementById("bg").style.display ="none";
		        $("body").css({overflow:"auto"})
		})
		
	})
  })
  function getDefaultAddress(){
	//得默认地址
  	$.ajax({
			url:'userAdress/getUserDefaultAddress',
			type:'get',
			success:function(data){
			if(data&&data.defaultUserAddress) {
				uReceiver = data.defaultUserAddress.oReceiver
				oPhone = data.defaultUserAddress.oPhone
				uAddress = data.defaultUserAddress.uAddress
				  var html = ""
				  html += "<div class=\"item-row\">"
				  html += "<span>收货人：&nbsp;&nbsp;"+uReceiver+"</span>"
				  html += " <span>"+oPhone+"</span></div>"
				  html += "<div>"+uAddress+"</div>"
				  $(".address-container").html(html)
			}
		  }
  		})
}
</script>
